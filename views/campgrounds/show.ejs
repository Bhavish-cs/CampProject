<% layout('layouts/boilerplate') %>
    <link rel="stylesheet" href="/stylesheets/campground-show.css">

    <div class="container campground-show-container">
        <div class="row">
            <div class="col-lg-8">
                <!-- Campground Main Card -->
                <div class="campground-main-card">
                    <!-- Image Carousel -->
                    <% if (campground.images && campground.images.length> 0) { %>
                        <div id="campgroundCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators">
                                <% campground.images.forEach((img, index)=> { %>
                                    <button type="button" data-bs-target="#campgroundCarousel"
                                        data-bs-slide-to="<%= index %>" class="<%= index === 0 ? 'active' : '' %>"
                                        aria-current="<%= index === 0 ? 'true' : 'false' %>">
                                    </button>
                                    <% }); %>
                            </div>
                            <div class="carousel-inner">
                                <% campground.images.forEach((img, index)=> { %>
                                    <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                        <img src="<%= img.url %>" alt="<%= campground.title %>">
                                    </div>
                                    <% }); %>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#campgroundCarousel"
                                data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#campgroundCarousel"
                                data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                        </div>
                        <% } else if (campground.image) { %>
                            <img src="<%= campground.image %>" style="width: 100%; height: 500px; object-fit: cover;">
                            <% } else { %>
                                <div
                                    style="height: 500px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image" style="font-size: 5rem; color: #1E3A5F; opacity: 0.3;"></i>
                                </div>
                                <% } %>

                                    <!-- Campground Info -->
                                    <div class="campground-info">
                                        <h1 class="campground-title">
                                            <%= campground.title %>
                                        </h1>
                                        <p class="campground-description">
                                            <%= campground.description %>
                                        </p>

                                        <% if (campground.images && campground.images.length> 1) { %>
                                            <div class="carousel-alert">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Tip:</strong> Use arrow keys or swipe to view <%=
                                                    campground.images.length %> images
                                            </div>
                                            <% } %>
                                    </div>

                                    <!-- Details List -->
                                    <ul class="campground-details-list">
                                        <li>
                                            <i class="fas fa-map-marker-alt"></i>
                                            <div>
                                                <strong>Location</strong><br>
                                                <span class="text-muted">
                                                    <%= campground.location %>
                                                </span>
                                            </div>
                                        </li>
                                        <li>
                                            <i class="fas fa-dollar-sign"></i>
                                            <div>
                                                <strong>Price</strong><br>
                                                <span class="price-highlight">$<%= campground.price %></span><span
                                                    class="text-muted">/night</span>
                                            </div>
                                        </li>
                                        <% if (campground.author) { %>
                                            <li>
                                                <i class="fas fa-user-circle"></i>
                                                <div>
                                                    <strong>Hosted by</strong><br>
                                                    <span class="text-muted">
                                                        <%= campground.author.username || 'Anonymous' %>
                                                    </span>
                                                </div>
                                            </li>
                                            <% } %>
                                    </ul>

                                    <!-- Action Buttons -->
                                    <% if (campground.author && currentUserId && campground.author._id &&
                                        campground.author._id.toString()===currentUserId.toString()) { %>
                                        <div class="campground-actions">
                                            <a href="/campgrounds/<%= campground._id %>/edit" class="btn btn-edit">
                                                <i class="fas fa-edit me-2"></i>Edit Campground
                                            </a>
                                            <form action="/campgrounds/<%= campground._id %>?_method=DELETE"
                                                method="POST" class="d-inline">
                                                <button type="submit" class="btn btn-delete">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </button>
                                            </form>
                                        </div>
                                        <% } %>

                                            <div class="campground-actions">
                                                <a href="/campgrounds" class="btn btn-back">
                                                    <i class="fas fa-arrow-left me-2"></i>All Campgrounds
                                                </a>
                                            </div>
                </div>

                <!-- Map Section -->
                <div class="map-section">
                    <div class="map-header">
                        <i class="fas fa-map-marked-alt"></i>
                        <h5>Location</h5>
                    </div>
                    <div id="campground-map"></div>
                    <div class="map-info-panel">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="map-info-title">
                                    <i class="fas fa-map-pin me-2"></i>
                                    <%= campground.title %>
                                </h6>
                                <p class="map-info-location">
                                    <i class="fas fa-location-arrow me-1"></i>
                                    <%= campground.location %>
                                </p>
                                <% if (campground.latitude && campground.longitude) { %>
                                    <small class="map-info-coords">
                                        <i class="fas fa-compass me-1"></i>
                                        <%= campground.latitude.toFixed(6) %>, <%= campground.longitude.toFixed(6) %>
                                    </small>
                                    <% } %>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="map-style-controls">
                                    <button class="btn-map-style" id="mapStyleStreets">
                                        <i class="fas fa-map"></i>
                                    </button>
                                    <button class="btn-map-style active" id="mapStyleOutdoor">
                                        <i class="fas fa-tree"></i>
                                    </button>
                                    <button class="btn-map-style" id="mapStyleSatellite">
                                        <i class="fas fa-satellite"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Reviews Section -->
                <div class="reviews-section">
                    <!-- Review Form -->
                    <div class="review-form-section">
                        <h2 class="review-form-title">
                            <i class="fas fa-star"></i>
                            Leave a Review
                        </h2>
                        <form action="/campgrounds/<%= campground._id %>/reviews" method="POST" class="needs-validation"
                            novalidate>
                            <div class="mb-3">
                                <label for="reviewBody" class="form-label">Your Review</label>
                                <textarea class="form-control" id="reviewBody" name="review[body]" rows="4"
                                    placeholder="Share your experience..." required minlength="5"
                                    maxlength="500"></textarea>
                                <div class="form-text">
                                    <span id="charCount">0</span>/500 characters
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a review (5-500 characters).
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Rating</label>
                                <div id="starRating">
                                    <% for(let i=1; i <=5; i++) { %>
                                        <span class="star" data-value="<%= i %>">
                                            <i class="fas fa-star"></i>
                                        </span>
                                        <% } %>
                                </div>
                                <input type="hidden" name="review[rating]" id="ratingInput" required>
                                <div class="invalid-feedback" id="ratingError" style="display: none;">
                                    Please select a rating.
                                </div>
                            </div>

                            <button type="submit" class="btn btn-submit-review w-100">
                                <i class="fas fa-paper-plane me-2"></i>Submit Review
                            </button>
                        </form>
                    </div>

                    <!-- Reviews List -->
                    <% if (campground.reviews && campground.reviews.length> 0) { %>
                        <div class="reviews-list-header">
                            <i class="fas fa-comments me-2"></i>
                            Reviews (<%= campground.reviews.length %>)
                        </div>
                        <div class="reviews-list">
                            <% campground.reviews.forEach((review)=> { %>
                                <div class="review-item">
                                    <div class="review-header">
                                        <div class="review-rating">
                                            <% for(let i=1; i <=5; i++) { %>
                                                <i
                                                    class="fas fa-star <%= i <= review.rating ? 'text-warning' : 'text-muted' %>"></i>
                                                <% } %>
                                        </div>
                                        <small class="review-date">
                                            <i class="fas fa-clock me-1"></i>
                                            <%= timeAgo ? timeAgo(review.createdAt || new Date()) : 'Recently' %>
                                        </small>
                                    </div>
                                    <p class="review-body">
                                        <%= review.body %>
                                    </p>
                                    <form
                                        action="/campgrounds/<%= campground._id %>/reviews/<%= review._id %>?_method=DELETE"
                                        method="POST">
                                        <button type="submit" class="btn btn-delete-review">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </form>
                                </div>
                                <% }); %>
                        </div>
                        <% } %>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Character counter
        const reviewBody = document.getElementById('reviewBody');
        const charCount = document.getElementById('charCount');

        if (reviewBody && charCount) {
            reviewBody.addEventListener('input', function () {
                charCount.textContent = this.value.length;
            });
        }

        // Star rating
        const stars = document.querySelectorAll('.star');
        const ratingInput = document.getElementById('ratingInput');
        let selectedRating = 0;

        stars.forEach((star) => {
            star.addEventListener('click', function () {
                selectedRating = parseInt(this.dataset.value);
                ratingInput.value = selectedRating;
                updateStars();
            });

            star.addEventListener('mouseenter', function () {
                const value = parseInt(this.dataset.value);
                stars.forEach((s, index) => {
                    if (index < value) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            });
        });

        document.getElementById('starRating').addEventListener('mouseleave', function () {
            updateStars();
        });

        function updateStars() {
            stars.forEach((s, index) => {
                if (index < selectedRating) {
                    s.classList.add('active');
                } else {
                    s.classList.remove('active');
                }
            });
        }

    // Map initialization
    <% if (campground.latitude && campground.longitude) { %>
        if (typeof maptilersdk !== 'undefined') {
                maptilersdk.config.apiKey = '<%= process.env.MAPTILER_API_KEY %>';
                const map = new maptilersdk.Map({
                    container: 'campground-map',
                    style: maptilersdk.MapStyle.OUTDOOR,
                    center: [<%= campground.longitude %>, <%= campground.latitude %>],
                    zoom: 12
                });

                new maptilersdk.Marker({ color: "#34A0A4" })
                    .setLngLat([<%= campground.longitude %>, <%= campground.latitude %>])
                    .setPopup(new maptilersdk.Popup().setHTML("<h6><%= campground.title %></h6><p><%= campground.location %></p>"))
                    .addTo(map);

                // Map style buttons
                document.getElementById('mapStyleStreets')?.addEventListener('click', () => {
                    map.setStyle(maptilersdk.MapStyle.STREETS);
                    updateActiveButton('mapStyleStreets');
                });
                document.getElementById('mapStyleOutdoor')?.addEventListener('click', () => {
                    map.setStyle(maptilersdk.MapStyle.OUTDOOR);
                    updateActiveButton('mapStyleOutdoor');
                });
                document.getElementById('mapStyleSatellite')?.addEventListener('click', () => {
                    map.setStyle(maptilersdk.MapStyle.SATELLITE);
                    updateActiveButton('mapStyleSatellite');
                });

                function updateActiveButton(activeId) {
                    document.querySelectorAll('.btn-map-style').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(activeId)?.classList.add('active');
                }
            }
    <% } %>

            // Form validation
            (function () {
                'use strict'
                const forms = document.querySelectorAll('.needs-validation')
                Array.from(forms).forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity() || !ratingInput.value) {
                            event.preventDefault()
                            event.stopPropagation()
                            if (!ratingInput.value) {
                                document.getElementById('ratingError').style.display = 'block';
                            }
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
            })()
    </script>