<% layout('layouts/boilerplate') %>
    <div class="row justify-content-center">
        <div class="col-8">
            <div class="card shadow-sm border-0 mb-4">
                <img src="<%= campground.image %>" class="card-img-top img-fluid" alt="..."
                    style="object-fit:cover; height:320px; border-top-left-radius:0.5rem; border-top-right-radius:0.5rem;">
                <div class="card-body">
                    <h5 class="card-title">
                        <%= campground.title %>
                    </h5>
                    <p class="card-text">
                        <%= campground.description %>.
                    </p>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item text-muted">
                        <i class="bi bi-geo-alt"></i> <%= campground.location %>
                    </li>
                    <li class="list-group-item">
                        <i class="bi bi-currency-dollar"></i> $<%= campground.price %>/night
                    </li>
                    <% if (campground.author) { %>
                        <li class="list-group-item text-muted">
                            <i class="bi bi-person-circle"></i> Hosted by <%= campground.author.username || 'Anonymous' %>
                        </li>
                    <% } %>
                </ul>
                <div class="card-body px-3 py-2">
                    <% if (campground.author && currentUserId && campground.author._id && campground.author._id.toString() === currentUserId.toString()) { %>
                        <div class="d-flex align-items-center gap-2 justify-content-center mb-3">
                            <a class="btn btn-info" href="/campgrounds/<%= campground._id %>/edit">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <form class="d-inline" action="/campgrounds/<%=campground._id%>?_method=DELETE" method="POST">
                                <button class="btn btn-danger">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    <% } %>
                    <div class="text-center">
                        <a href="/campgrounds" class="btn btn-outline-success fw-bold"
                            style="letter-spacing: 1px; padding: 0.5rem 1.2rem;">
                            <i class="bi bi-arrow-left-circle"></i> All Campgrounds
                        </a>
                    </div>
                </div>
                <!-- Review Submission Form in a separate div -->
            </div> <!-- close card -->
        </div> <!-- close col -->
    </div> <!-- close row -->

    <div class="row justify-content-center mt-4">
        <div class="col-8">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="mb-3 text-primary"><i class="bi bi-chat-dots"></i> Leave a Review</h5>
                    <form action="/campgrounds/<%= campground._id %>/reviews" method="POST" class="needs-validation"
                        novalidate>
                        <div class="mb-3">
                            <label for="reviewBody" class="form-label fw-semibold">Your Review</label>
                            <textarea class="form-control" id="reviewBody" name="review[body]" rows="4"
                                placeholder="Share your experience... (minimum 5 characters)" required minlength="5"
                                maxlength="500"></textarea>
                            <div class="invalid-feedback">
                                Please provide a review between 5 and 500 characters.
                            </div>
                            <div class="form-text">
                                <span id="charCount">0</span>/500 characters
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold d-block mb-1">Rating</label>
                            <div id="starRating" class="mb-1" style="font-size:2rem;">
                                <% for(let i=1; i<=5; i++) { %>
                                    <span class="star" data-value="<%=i%>"
                                        style="color:#ddd; cursor:pointer; transition:color 0.2s;">
                                        <i class="bi bi-star-fill"></i>
                                    </span>
                                    <% } %>
                                        <input type="hidden" name="review[rating]" id="ratingInput" required>
                            </div>
                            <div class="invalid-feedback" id="ratingError" style="display: none;">
                                Please select a rating (1-5 stars).
                            </div>
                        </div>
                        <button type="submit" class="btn px-4 py-2 fw-bold shadow-sm" id="submitBtn"
                            style="background: #ffd814; color: #111; border: 1px solid #fcd200; border-radius: 20px; letter-spacing: 1px; box-shadow: 0 2px 5px rgba(0,0,0,0.07); font-weight: 600; font-size: 1.1rem;">
                            <i class="bi bi-send"></i> Submit Review
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Display Existing Reviews -->
    <% if (campground.reviews && campground.reviews.length> 0) { %>
        <div class="row justify-content-center mt-4">
            <div class="col-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 text-dark">
                            <i class="bi bi-chat-square-text"></i>
                            Reviews (<%= campground.reviews.length %>)
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <% campground.reviews.forEach((review, index)=> { %>
                            <div
                                class="border-bottom p-3 <%= index === campground.reviews.length - 1 ? 'border-0' : '' %>">
                                <!-- Star Rating Display and Delete Button -->
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <% for(let i=1; i <=5; i++) { %>
                                                <% if(i <=review.rating) { %>
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                    <% } else { %>
                                                        <i class="bi bi-star text-muted"></i>
                                                        <% } %>
                                                            <% } %>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-clock"></i>
                                            <%= timeAgo(review.createdAt) %>
                                        </small>
                                    </div>
                                    <!-- Delete Button -->
                                    <form class="d-inline"
                                        action="/campgrounds/<%= campground._id %>/reviews/<%= review._id %>?_method=DELETE"
                                        method="POST">
                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('Are you sure you want to delete this review?')"
                                            title="Delete Review">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                                <!-- Review Body -->
                                <p class="mb-0 text-dark">
                                    <%= review.body %>
                                </p>
                            </div>
                            <% }); %>
                    </div>
                </div>
            </div>
        </div>
        <% } else { %>
            <div class="row justify-content-center mt-4">
                <div class="col-8">
                    <div class="card shadow-sm border-0 bg-light">
                        <div class="card-body text-center py-4">
                            <i class="bi bi-chat-square-dots fs-1 text-muted mb-3"></i>
                            <h6 class="text-muted mb-0">No reviews yet. Be the first to review this campground!</h6>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>

                <script>
                    // Enhanced form validation and interactivity
                    document.addEventListener('DOMContentLoaded', function () {
                        const stars = document.querySelectorAll('#starRating .star');
                        const ratingInput = document.getElementById('ratingInput');
                        const reviewBody = document.getElementById('reviewBody');
                        const charCount = document.getElementById('charCount');
                        const form = document.querySelector('.needs-validation');
                        const submitBtn = document.getElementById('submitBtn');
                        const ratingError = document.getElementById('ratingError');

                        let selected = 0;

                        // Star rating functionality
                        stars.forEach((star, idx) => {
                            star.addEventListener('mouseover', () => {
                                highlightStars(idx + 1);
                            });
                            star.addEventListener('mouseout', () => {
                                highlightStars(selected);
                            });
                            star.addEventListener('click', () => {
                                selected = idx + 1;
                                ratingInput.value = selected;
                                highlightStars(selected);
                                // Hide rating error message completely
                                ratingError.style.display = 'none';
                                ratingError.style.visibility = 'hidden';
                                ratingError.classList.remove('d-block');
                                validateForm();
                            });
                        });

                        function highlightStars(count) {
                            stars.forEach((star, i) => {
                                star.style.color = i < count ? '#ffd700' : '#ddd';
                            });
                        }

                        // Character counting
                        reviewBody.addEventListener('input', function () {
                            const currentLength = this.value.length;
                            charCount.textContent = currentLength;

                            if (currentLength > 500) {
                                charCount.style.color = '#dc3545';
                            } else if (currentLength < 5) {
                                charCount.style.color = '#6c757d';
                            } else {
                                charCount.style.color = '#198754';
                            }

                            validateForm();
                        });

                        // Form validation
                        function validateForm() {
                            const bodyValid = reviewBody.value.trim().length >= 5 && reviewBody.value.trim().length <= 500;
                            const ratingValid = selected > 0;

                            // Hide rating error if rating is valid
                            if (ratingValid) {
                                ratingError.style.display = 'none';
                                ratingError.style.visibility = 'hidden';
                                ratingError.classList.remove('d-block');
                            }

                            if (bodyValid && ratingValid) {
                                submitBtn.disabled = false;
                                submitBtn.style.opacity = '1';
                            } else {
                                submitBtn.disabled = true;
                                submitBtn.style.opacity = '0.6';
                            }
                        }

                        // Form submission validation
                        form.addEventListener('submit', function (event) {
                            event.preventDefault();
                            event.stopPropagation();

                            const bodyValid = reviewBody.value.trim().length >= 5 && reviewBody.value.trim().length <= 500;
                            const ratingValid = selected > 0;

                            if (!bodyValid) {
                                reviewBody.classList.add('is-invalid');
                            }

                            if (!ratingValid) {
                                ratingError.style.display = 'block';
                                ratingError.style.visibility = 'visible';
                                ratingError.classList.add('d-block');
                            }

                            if (bodyValid && ratingValid) {
                                form.classList.add('was-validated');
                                // Submit the form
                                this.submit();
                            } else {
                                // Show validation errors
                                form.classList.add('was-validated');
                            }
                        });

                        // Initial validation
                        validateForm();
                    });
                </script>
                </div>
                </div>
                </div>
                <p class="text-muted small">
                    Posted <%= timeAgo(campground.createdAt) %>
                </p>